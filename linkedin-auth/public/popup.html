<!doctype html>
<!--
  Copyright 2016 Google Inc. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
      https://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Demonstrates how to authorize Firebase with LinkedIn auth using Firebase Functions">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authenticate with LinkedIn</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.0.5/es6-promise.auto.min.js"></script>
</head>
<body>

Please wait...

<!-- Firebase -->
<!-- ***********************************************************************************************************************
     * TODO(DEVELOPER): Paste the initialization snippet from: Firebase Console > Overview > Add Firebase to your web app. *
     *********************************************************************************************************************** -->

<script>
  /**
   * Returns the value of the given URL query parameter.
   */
  function getURLParameter(name) {
    return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) ||
        [null, ''])[1].replace(/\+/g, '%20')) || null;
  }

  /**
   * Returns the ID of the Firebase project.
   */
  function getFirebaseProjectId() {
    return firebase.app().options.authDomain.split('.')[0];
  }

  /**
   * This callback is called by the JSONP callback of the 'token' Firebase Function with the Firebase auth token.
   */
  function tokenReceived(data) {
    if (data.token) {
      signInFirebase(data.token, data.email, data.displayName, data.photoURL, data.linkedInAccessToken);
    } else {
      console.error(error);
      document.body.innerText = 'Error in the token Function: ' + data.error;
    }
  }

  /**
   *  - Signs the user in Firebase using the given token
   *  - Updates the user profile (photoURL and displayName)
   *  - Saves the LinkedIn AccessToken in the Realtime Database
   *  - Closes the popup
   */
  function signInFirebase(token, email, displayName, photoURL, linkedInAccessToken) {
    // We sign in via a temporary Firebase app to update the profile.
    var tempApp = firebase.initializeApp(config, '_temp_');
    tempApp.auth().signInWithCustomToken(token).then(function(user) {

      // Saving the LinkedIn API access token in the Realtime Database.
      const tasks = [tempApp.database().ref('/linkedInAccessToken/' + user.uid).set(linkedInAccessToken)];

      // Updating the displayname and photoURL if needed.
      if (displayName !== user.displayName || photoURL !== user.photoURL) {
        tasks.push(user.updateProfile({displayName: displayName, photoURL: photoURL}));
      }

      // Updating the email if needed.
      if (email !== user.email) {
        tasks.push(user.updateEmail(email));
      }

      // Wait for completion of above tasks.
      return Promise.all(tasks).then(function() {
        // Delete temporary Firebase app and sign in the default Firebase app, then close the popup.
        Promise.all([tempApp.delete(), firebase.auth().signInWithCustomToken(token)]).then(function() {
          window.close();
        });
      });
    }).catch(function(error) {
      console.error(error);
      document.body.innerText = 'Error While using the Firebase Auth token to sign in: ' + error.message;
    });
  }

  var code = getURLParameter('code');
  var state = getURLParameter('state');
  var error = getURLParameter('error');
  if (!code) {
    document.body.innerText = 'Error back from the LinkedIn auth page: ' + error;
  } else {
    // Use JSONP to load the 'token' Firebase Function to exchange the auth code against a Firebase custom token.
    const script = document.createElement('script');
    script.type = 'text/javascript';
    // This is the URL to the HTTP triggered 'token' Firebase Function.
    // See https://firebase.google.com/preview/functions/gcp-events#handle_a_cloud_http_firebase_function_event.
    var tokenFunctionURL = 'https://us-central1-' + getFirebaseProjectId() + '.cloudfunctions.net/token';
    script.src = tokenFunctionURL +
        '?code=' + encodeURIComponent(code) +
        '&state=' + encodeURIComponent(state) +
        '&callback=' + tokenReceived.name;
    document.head.appendChild(script);
  }
</script>
</body>
</html>
