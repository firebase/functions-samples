<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloud Functions for Firebase (Stripe example)</title>
    <script src="https://js.stripe.com/v3/"></script>
    <link
      type="text/css"
      rel="stylesheet"
      href="https://www.gstatic.com/firebasejs/ui/4.5.0/firebase-ui-auth.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1/new.min.css"
    />
  </head>
  <body>
    <section id="firebaseui-auth-container"></section>
    <div id="loader">Loading &hellip;</div>
    <section id="content" style="display: none;">
      <button type="button" id="signout">
        Sign out
      </button>
      <div>
        <h1>Payment Methods</h1>
        <ul></ul>
        <hr />
        <h2>Add new</h2>
        <form>
          <label>
            Cardholder name
            <input type="text" name="name" />
          </label>
          <fieldset>
            <legend>Card details</legend>
            <div id="card-element"></div>
          </fieldset>
          <button>Save Card</button>
        </form>
      </div>
      <div>
        <h1>Charges</h1>
      </div>
    </section>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="/__/firebase/7.14.5/firebase-app.js"></script>
    <script src="/__/firebase/7.14.5/firebase-auth.js"></script>
    <script src="/__/firebase/7.14.5/firebase-firestore.js"></script>
    <!-- Initialize Firebase -->
    <script src="/__/firebase/init.js"></script>
    <!-- Import Firebase UI -->
    <script src="https://www.gstatic.com/firebasejs/ui/4.5.0/firebase-ui-auth.js"></script>

    <script>
      let currentUser = {};
      let customerData = {};

      /* Firebase auth */
      const firebaseUI = new firebaseui.auth.AuthUI(firebase.auth());
      const firebaseAuthOptions = {
        callbacks: {
          signInSuccess: (currentUser, credential, redirectUrl) => {
            return false;
          },
          uiShown: () => {
            document.getElementById('loader').style.display = 'none';
          },
        },
        signInFlow: 'popup',
        signInSuccessUrl: '/',
        signInOptions: [firebase.auth.GoogleAuthProvider.PROVIDER_ID],
        tosUrl: '/',
      };
      firebase.auth().onAuthStateChanged((firebaseUser) => {
        if (firebaseUser) {
          currentUser = firebaseUser;
          firebase
            .firestore()
            .collection('stripe_customers')
            .doc(currentUser.uid)
            .onSnapshot((snapshot) => {
              if (snapshot.data()) {
                customerData = snapshot.data();
                document.getElementById('loader').style.display = 'none';
                document.getElementById('content').style.display = 'block';
              }
            });
        } else {
          document.getElementById('content').style.display = 'none';
          firebaseUI.start('#firebaseui-auth-container', firebaseAuthOptions);
        }
      });

      /* Set up Stripe Elements */
      const stripe = Stripe('pk_test_vLrqIOp4auLRV7z07T36fiTC00ZuF9N2o2');
      const elements = stripe.elements();
      const cardElement = elements.create('card');
      cardElement.mount('#card-element');

      /* Data listeners */

      /* Event listeners */
      // Signout button
      document
        .getElementById('signout')
        .addEventListener('click', () => firebase.auth().signOut());
      // Add new card form
      document
        .querySelector('form')
        .addEventListener('submit', async (event) => {
          event.preventDefault();
          document
            .querySelectorAll('button')
            .forEach((button) => (button.disabled = true));

          const form = new FormData(event.target);
          const cardholderName = form.get('name');

          const { setupIntent, error } = await stripe.confirmCardSetup(
            customerData.setup_secret,
            {
              payment_method: {
                card: cardElement,
                billing_details: {
                  name: cardholderName,
                },
              },
            }
          );

          if (error) {
            console.warn(error);
            document
              .querySelectorAll('button')
              .forEach((button) => (button.disabled = false));
          }

          await firebase
            .firestore()
            .collection('stripe_customers')
            .doc(currentUser.uid)
            .collection('payment_methods')
            .add({ payment_method: setupIntent.payment_method });
        });
    </script>
  </body>
</html>
